<?php
/* ----------------------------------------------------------------------
   $Id$

   OOS [OSIS Online Shop]
   http://www.oos-shop.de/

   Copyright (c) 2003 - 2009 by the OOS Development Team.
   ----------------------------------------------------------------------
   Based on:

   File: payment.php,v 1.3.2.1 2003/05/03 23:41:23 wilt
   orig: payment.php,v 1.36 2003/02/11 00:04:53 hpdl
   ----------------------------------------------------------------------
   osCommerce, Open Source E-Commerce Solutions
   http://www.oscommerce.com

   Copyright (c) 2003 osCommerce
   ----------------------------------------------------------------------
   Released under the GNU General Public License
   ---------------------------------------------------------------------- */

/** ensure this file is being included by a parent file */
defined( 'OOS_VALID_MOD' ) or die( 'Direct Access to this location is not allowed.' );


/**
 * Class Payment
 *
 * @category   OOS [OSIS Online Shop]
 * @package    Payment
 * @copyright  Copyright (c) 2003 - 2009 by the OOS Development Team. (http://www.oos-shop.de/)
 * @license    http://www.gnu.org/licenses/gpl.html GNU General Public License
 */
 class payment
 {
    var $modules, $selected_module;

// class constructor
    public function __construct($module = '')
    {
        global $aLang;

        if (defined('MODULE_PAYMENT_INSTALLED') && !empty($_SESSION['member']->group['payment'])) {
            $this->modules = explode(';', $_SESSION['member']->group['payment']);

            $include_modules = array();

            if ( (!empty($module)) && (in_array($module . '.' . substr($_SERVER['PHP_SELF'], (strrpos($_SERVER['PHP_SELF'], '.')+1)), $this->modules)) ) {
                $this->selected_module = $module;

                $include_modules[] = array('class' => $module, 'file' => $module . '.php');
            } else {
                reset($this->modules);
                while (list(, $value) = each($this->modules)) {
                    $class = substr($value, 0, strrpos($value, '.'));
                    $include_modules[] = array('class' => $class, 'file' => $value);
                }
            }

            $sLanguage = oos_var_prep_for_os($_SESSION['language']);

            $nArrayCountModules = count($include_modules);
            for ($i=0, $n = $nArrayCountModules; $i<$n; $i++) {
                include 'includes/languages/' . $sLanguage . '/modules/payment/' . $include_modules[$i]['file'];
                include 'includes/modules/payment/' . $include_modules[$i]['file'];

                $GLOBALS[$include_modules[$i]['class']] = new $include_modules[$i]['class'];
            }

            // if there is only one payment method, select it as default because in
            // checkout_confirmation.php the $payment variable is being assigned the
            if ( (oos_count_payment_modules() == 1) && (!is_object($_SESSION['payment'])) ) {
                $_SESSION['payment'] = $include_modules[0]['class'];
            }

            if ( (!empty($module)) && (in_array($module, $this->modules)) && (isset($GLOBALS[$module]->form_action_url)) ) {
                $this->form_action_url = $GLOBALS[$module]->form_action_url;
            }
        }
    }


   // class methods
   /* The following method is needed in the checkout_confirmation.php page
      due to a chicken and egg problem with the payment class and order class.
      The payment modules needs the order destination data for the dynamic status
      feature, and the order class needs the payment module title.
      The following method is a work-around to implementing the method in all
      payment modules available which would break the modules in the contributions
      section. This should be looked into again post 2.2.
    */
    function update_status()
    {
        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module])) {
                if (function_exists('method_exists')) {
                    if (method_exists($GLOBALS[$this->selected_module], 'update_status')) {
                        $GLOBALS[$this->selected_module]->update_status();
                    }
                }
            }
        }
    }


    function javascript_validation()
    {
        global $aLang;

        $js = '';
        if (is_array($this->modules)) {

            if (OOS_XHTML == '1') {
                $js = '<script type= "text/javascript">/*<![CDATA[*/' . "\n";
            } else {
                $js = '<script language="javascript"><!-- ' . "\n";
            }
            $js .= 'function check_form() {' . "\n" .
                   '  var error = 0;' . "\n" .
                   '  var error_message = "' . decode($aLang['js_error']) . '";' . "\n" .
                   '  var payment_value = null;' . "\n" .
                   '  if (document.checkout_payment.payment.length) {' . "\n" .
                   '    for (var i=0; i<document.checkout_payment.payment.length; i++) {' . "\n" .
                   '      if (document.checkout_payment.payment[i].checked) {' . "\n" .
                   '        payment_value = document.checkout_payment.payment[i].value;' . "\n" .
                   '      }' . "\n" .
                   '    }' . "\n" .
                   '  } else if (document.checkout_payment.payment.checked) {' . "\n" .
                   '    payment_value = document.checkout_payment.payment.value;' . "\n" .
                   '  } else if (document.checkout_payment.payment.value) {' . "\n" .
                   '    payment_value = document.checkout_payment.payment.value;' . "\n" .
                   '  }' . "\n\n";

            reset($this->modules);
            while (list(, $value) = each($this->modules)) {
                $class = substr($value, 0, strrpos($value, '.'));
                if ($GLOBALS[$class]->enabled) {
                    $js .= $GLOBALS[$class]->javascript_validation();
                }
            }

            if (DISPLAY_CONDITIONS_ON_CHECKOUT == '1') {
                $js .= "\n" . '  if (!document.getElementById("1").checked) {' . "\n" .
                       '    error_message = error_message + unescape("' . decode($aLang['error_conditions_not_accepted']) . '");' . "\n" .
                       '    error = 1;' . "\n" .
                       '  }' . "\n\n";
            }

            $js .= "\n" . '  if (payment_value == null && submitter != 1) {' . "\n" . // ICW CREDIT CLASS Gift Voucher System
                   '    error_message = error_message + "' . decode($aLang['js_error_no_payment_module_selected']) . '";' . "\n" .
                   '    error = 1;' . "\n" .
                   '  }' . "\n\n" .
                   '  if (error == 1 && submitter != 1) {' . "\n" .
                   '    alert(error_message);' . "\n" .
                   '    return false;' . "\n" .
                   '  } else {' . "\n" .
                   '    return true;' . "\n" .
                   '  }' . "\n" .
                   '}' . "\n";

            if (OOS_XHTML == '1') {
                $js .= '/*]]>*/</script>' . "\n";
            } else {
                $js .= '//--></script>' . "\n";
            }

        }

        return $js;
    }


    function selection()
    {
        $selection_array = array();

        if (is_array($this->modules)) {
            reset($this->modules);
            while (list(, $value) = each($this->modules)) {
                $class = substr($value, 0, strrpos($value, '.'));
                if ($GLOBALS[$class]->enabled) {
                    $selection = $GLOBALS[$class]->selection();
                    if (is_array($selection)) $selection_array[] = $selection;
                }
            }
        }

        return $selection_array;
    }


    function pre_confirmation_check()
    {
        global $credit_covers, $payment_modules;

        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module]) && ($GLOBALS[$this->selected_module]->enabled) ) {

                if ($credit_covers) {
                    $GLOBALS[$this->selected_module]->enabled = false;
                    $GLOBALS[$this->selected_module] = NULL;
                    $payment_modules = '';
                } else {
                    $GLOBALS[$this->selected_module]->pre_confirmation_check();
                }
            }
        }
    }


    function confirmation()
    {
        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module]) && ($GLOBALS[$this->selected_module]->enabled) ) {
                return $GLOBALS[$this->selected_module]->confirmation();
            }
        }
    }


    function process_button()
    {
        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module]) && ($GLOBALS[$this->selected_module]->enabled) ) {
                return $GLOBALS[$this->selected_module]->process_button();
            }
        }
    }


    function before_process()
    {
        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module]) && ($GLOBALS[$this->selected_module]->enabled) ) {
                return $GLOBALS[$this->selected_module]->before_process();
            }
        }
    }


    function after_process()
    {
        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module]) && ($GLOBALS[$this->selected_module]->enabled) ) {
                return $GLOBALS[$this->selected_module]->after_process();
            }
        }
    }


    function get_error()
    {
        if (is_array($this->modules)) {
            if (is_object($GLOBALS[$this->selected_module]) && ($GLOBALS[$this->selected_module]->enabled) ) {
                return $GLOBALS[$this->selected_module]->get_error();
            }
        }
    }

}
